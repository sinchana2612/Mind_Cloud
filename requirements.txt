from flask import Flask, render_template, request, redirect, session
from werkzeug.security import generate_password_hash, check_password_hash
import mysql.connector
from datetime import datetime
import subprocess

app = Flask(__name__)
app.secret_key = "super_secret_key_123"

# ---------------- DATABASE CONNECTION ----------------
def get_db():
    return mysql.connector.connect(
        host="localhost",
        user="root",
        password="Vars_13613",
        database="counselling_system"
    )

# ---------------- LOGIN REQUIRED DECORATOR ----------------
def login_required(role=None):
    def decorator(func):
        def wrapper(*args, **kwargs):
            if "user_id" not in session:
                return redirect("/")
            if role and session.get("role") != role:
                return "Unauthorized Access", 403
            return func(*args, **kwargs)
        wrapper.__name__ = func.__name__
        return wrapper
    return decorator

# ---------------- LOGIN PAGE ----------------
@app.route("/")
def login_page():
    return render_template("login.html")

# ---------------- LOGIN LOGIC ----------------
@app.route("/login", methods=["POST"])
def login():
    usn = request.form["USN"]
    password = request.form["password"]
    role = request.form["role"]

    db = get_db()
    cursor = db.cursor(dictionary=True)

    cursor.execute(
        "SELECT * FROM users WHERE USN=%s AND role=%s",
        (usn, role)
    )
    user = cursor.fetchone()

    if not user:
        return render_template("login.html", error="Invalid USN or Role")

    if not check_password_hash(user["password"], password):
        return render_template("login.html", error="Incorrect Password")

    session["user_id"] = user["id"]
    session["role"] = user["role"]
    session["name"] = user["UserName"]

    if role == "admin":
        return redirect("/admin/dashboard")
    elif role == "teacher":
        return redirect("/teacher/dashboard")
    else:
        return redirect("/student/dashboard")

# ---------------- LOGOUT ----------------
@app.route("/logout")
def logout():
    session.clear()
    return redirect("/")

# ======================================================
# ===================== ADMIN ROUTES ===================
# ======================================================

@app.route("/admin/dashboard")
@login_required("admin")
def admin_dashboard():
    return render_template("admin/dashboard.html", name=session["name"])

@app.route("/admin/create-user")
@login_required("admin")
def admin_create_user():
    return render_template("admin/create_user.html", name=session["name"])

@app.route("/admin/users", methods=["GET", "POST"])
@login_required("admin")
def admin_users():
    db = get_db()
    cursor = db.cursor(dictionary=True)

    if request.method == "POST":
        cursor.execute(
            """
            INSERT INTO users (UserName, USN, password, role)
            VALUES (%s, %s, %s, %s)
            """,
            (
                request.form["name"],
                request.form["USN"],
                generate_password_hash(request.form["password"]),
                request.form["role"]
            )
        )
        db.commit()

    cursor.execute("SELECT id, UserName, USN, role FROM users")
    users = cursor.fetchall()

    return render_template(
        "admin/user.html",
        users=users,
        name=session["name"]
    )

@app.route("/admin/assign", methods=["GET", "POST"])
@login_required("admin")
def admin_assign():
    db = get_db()
    cursor = db.cursor(dictionary=True)

    if request.method == "POST":
        cursor.execute(
            "UPDATE students SET assigned_teacher_id=%s WHERE id=%s",
            (request.form["teacher_id"], request.form["student_id"])
        )
        db.commit()
        return redirect("/admin/assign")

    cursor.execute("""
        SELECT s.id, u.UserName AS student_name
        FROM students s
        JOIN users u ON s.user_id = u.id
    """)
    students = cursor.fetchall()

    cursor.execute("""
        SELECT t.id, u.UserName AS teacher_name
        FROM teachers t
        JOIN users u ON t.user_id = u.id
    """)
    teachers = cursor.fetchall()

    return render_template(
        "admin/assign.html",
        students=students,
        teachers=teachers,
        name=session["name"]
    )

# ======================================================
# ===================== STUDENT ROUTES =================
# ======================================================

@app.route("/student/dashboard")
@login_required("student")
def student_dashboard():
    return render_template("student/dashboard.html", name=session["name"])

@app.route("/student/reply/<int:request_id>", methods=["GET", "POST"])
@login_required("student")
def student_reply(request_id):
    db = get_db()
    cursor = db.cursor(dictionary=True)

    if request.method == "POST":
        cursor.execute("""
            INSERT INTO counselling_messages (request_id, sender_role, message)
            VALUES (%s, 'student', %s)
        """, (
            request_id,
            request.form["message"]
        ))
        db.commit()
        return redirect(f"/student/reply/{request_id}")

    cursor.execute("""
        SELECT sender_role, message, created_at
        FROM counselling_messages
        WHERE request_id=%s
        ORDER BY created_at
    """, (request_id,))

    messages = cursor.fetchall()

    return render_template(
        "student/reply.html",
        messages=messages,
        request_id=request_id,
        name=session["name"]
    )


@app.route("/student/request", methods=["GET", "POST"])
@login_required("student")
def student_request():
    db = get_db()
    cursor = db.cursor(dictionary=True)

    if request.method == "POST":
        cursor.execute(
            "SELECT id FROM students WHERE user_id=%s",
            (session["user_id"],)
        )
        student = cursor.fetchone()

        cursor.execute("""
            INSERT INTO counselling_requests
            (student_id, problem, category, status)
            VALUES (%s, %s, %s, 'Pending')
        """, (
            student["id"],
            request.form["problem"],
            request.form["category"]
        ))
        db.commit()
        return redirect("/student/history")

    return render_template("student/request.html", name=session["name"])

@app.route("/student/history")
@login_required("student")
def student_history():
    db = get_db()
    cursor = db.cursor(dictionary=True)

    cursor.execute("""
        SELECT cr.problem, cr.category, cr.status,
               cres.teacher_response
        FROM counselling_requests cr
        LEFT JOIN counselling_responses cres
        ON cr.id = cres.request_id
        WHERE cr.student_id = (
            SELECT id FROM students WHERE user_id=%s
        )
    """, (session["user_id"],))

    return render_template(
        "student/history.html",
        history=cursor.fetchall(),
        name=session["name"]
    )

# ======================================================
# ===================== TEACHER ROUTES =================
# ======================================================

@app.route("/teacher/dashboard")
@login_required("teacher")
def teacher_dashboard():
    return render_template("teacher/dashboard.html", name=session["name"])

@app.route("/teacher/request", methods=["GET", "POST"])
@login_required("teacher")
def teacher_request():
    db = get_db()
    cursor = db.cursor(dictionary=True)

    ai_text = None
    selected_request_id = None

    if request.method == "POST" and "generate_ai" in request.form:
        selected_request_id = request.form["request_id"]
        cursor.execute(
            "SELECT problem FROM counselling_requests WHERE id=%s",
            (selected_request_id,)
        )
        ai_text = gemma_response(cursor.fetchone()["problem"])

   elif request.method == "POST" and "submit_response" in request.form:

    request_id = request.form["request_id"]

    cursor.execute("""
        INSERT INTO counselling_responses
        (request_id, ai_response, teacher_response, completed_at)
        VALUES (%s, %s, %s, %s)
    """, (
        request_id,
        request.form["ai_response"],
        request.form["teacher_response"],
        datetime.now()
    ))

    # ðŸ”¥ STORE TEACHER MESSAGE FOR CONVERSATION
    cursor.execute("""
        INSERT INTO counselling_messages (request_id, sender_role, message)
        VALUES (%s, 'teacher', %s)
    """, (
        request_id,
        request.form["teacher_response"]
    ))

    cursor.execute(
        "UPDATE counselling_requests SET status='Completed' WHERE id=%s",
        (request_id,)
    )

    db.commit()
    return redirect("/teacher/history")

        cursor.execute("""
            INSERT INTO counselling_responses
            (request_id, ai_response, teacher_response, completed_at)
            VALUES (%s, %s, %s, %s)
        """, (
            request.form["request_id"],
            request.form["ai_response"],
            request.form["teacher_response"],
            datetime.now()
        ))
        cursor.execute(
            "UPDATE counselling_requests SET status='Completed' WHERE id=%s",
            (request.form["request_id"],)
        )
        db.commit()
        return redirect("/teacher/history")

    # âœ… FIXED QUERY â†’ includes STUDENT NAME
    cursor.execute("""
        SELECT 
            cr.id,
            cr.problem,
            cr.category,
            u.UserName AS student_name
        FROM counselling_requests cr
        JOIN students s ON cr.student_id = s.id
        JOIN users u ON s.user_id = u.id
        JOIN teachers t ON s.assigned_teacher_id = t.id
        WHERE t.user_id=%s
          AND cr.status='Pending'
    """, (session["user_id"],))

    return render_template(
        "teacher/request.html",
        requests=cursor.fetchall(),
        ai_text=ai_text,
        selected_request_id=selected_request_id,
        name=session["name"]
    )

@app.route("/teacher/history")
@login_required("teacher")
def teacher_history():
    db = get_db()
    cursor = db.cursor(dictionary=True)

    cursor.execute("""
        SELECT cr.problem, cres.teacher_response, cres.completed_at
        FROM counselling_responses cres
        JOIN counselling_requests cr ON cres.request_id = cr.id
    """)

    return render_template(
        "teacher/history.html",
        history=cursor.fetchall(),
        name=session["name"]
    )

# ======================================================
# ===================== GEMMA AI =======================
# ======================================================

def gemma_response(problem):
    try:
        prompt = f"""
You are a supportive college mentor.

Write in a natural, friendly way.
Give practical lifestyle tips and small daily changes.
Long responses are fine.
Do not use bullet points, stars, bold text, or markdown.
Do not start with phrases like "Sure" or "Here are".
Write only plain paragraphs.
Do not use bullet points, stars, bold text,or markdown

Student problem:
{problem}

Response:
"""

        result = subprocess.run(
            ["ollama", "run", "gemma:2b"],
            input=prompt,
            text=True,
            capture_output=True,
            encoding="utf-8",
            errors="ignore",
            timeout=60   # ðŸ”¥ increased timeout
        )

        if result.stdout and result.stdout.strip():
            return result.stdout.strip()
        else:
            return "The AI could not generate a response. Please try again."

    except subprocess.TimeoutExpired:
        return "AI is taking longer than usual. Please try again in a moment."
    except Exception as e:
        return f"AI Error: {e}"




# ---------------- RUN APP ----------------
if __name__ == "__main__":
    app.run(debug=True)
